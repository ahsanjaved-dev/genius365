# Cron Jobs System

## Overview

Genius365 uses a consolidated cron job system optimized for Vercel's Hobby plan limits.

- **Plan Limit**: 2 cron invocations per day (max)
- **Solution**: 1 master cron running twice daily at **UTC 00:00 and 12:00**
- **Status**: ‚úÖ Compliant and scalable

---

## Architecture

### Current Setup

```
vercel.json
‚îî‚îÄ‚îÄ crons: [
      { path: "/api/cron/master", schedule: "0 0,12 * * *" }
    ]
```

**Master Cron** (`/api/cron/master`)
- Runs every 12 hours
- Orchestrates all background tasks
- Gracefully handles individual task failures
- Returns detailed results and error logs

---

## Endpoints

### Master Cron Orchestrator

**Endpoint**: `POST /api/cron/master`

**Schedule**: Every 12 hours (UTC 00:00 and 12:00)

**Security**: Requires `Authorization: Bearer {CRON_SECRET}` header

**Response**:
```json
{
  "success": true,
  "totalDurationMs": 1234,
  "results": {
    "cleanupExpiredCampaigns": {
      "success": true,
      "cancelledCount": 5,
      "errorCount": 0,
      "durationMs": 234
    }
  },
  "timestamp": "2026-01-07T12:00:00.000Z"
}
```

### Legacy Cleanup Endpoint (On-Demand)

**Endpoint**: `POST /api/cron/cleanup-expired-campaigns`

**Status**: ‚úÖ Still available for manual testing/emergency cleanup

**Note**: No longer in scheduled cron (kept for backward compatibility)

---

## Tasks

### Task 1: Cleanup Expired Campaigns ‚úÖ ACTIVE

**File**: `lib/campaigns/cleanup-expired.ts`

**What it does**:
- Finds campaigns with `status = "draft"` that have passed `scheduled_expires_at`
- Updates status to `"cancelled"`
- Logs results

**Schedule**: Every 12 hours

**Examples**:
- User creates campaign with expiry date 2026-01-05
- Campaign is still in draft state
- Cron runs on 2026-01-06 ‚Üí Campaign marked as cancelled

---

### Task 2: Send Expiring Notifications üîÑ PLANNED

**File**: `lib/campaigns/expiring-notifications.ts` (not yet created)

**What it will do**:
- Find campaigns expiring within next 24 hours
- Send email notifications to workspace owners
- Log sent notifications

**Status**: Placeholder in master cron (commented out)

**To Enable**:
1. Create `lib/campaigns/expiring-notifications.ts`
2. Uncomment task in `/api/cron/master/route.ts`
3. Deploy

---

### Task 3: Sync Agents to Providers üîÑ PLANNED

**File**: `lib/campaigns/sync-agents.ts` (not yet created)

**What it will do**:
- Check agents with `needs_resync = true`
- Call VAPI/Retell/Synthflow APIs to update agent config
- Update `sync_status`, `last_synced_at`, `last_sync_error`

**Status**: Placeholder in master cron (commented out)

**Note**: Heavy operation - consider less frequent schedule or event-driven approach

**To Enable**:
1. Create `lib/campaigns/sync-agents.ts`
2. Uncomment task in `/api/cron/master/route.ts`
3. Consider frequency (every 12h, daily, weekly, or on-demand?)
4. Deploy

---

## Testing

### Local Testing

```bash
# Test the master cron endpoint
curl -X POST http://localhost:3000/api/cron/master \
  -H "Authorization: Bearer your-secret"

# Health check
curl http://localhost:3000/api/cron/master
```

### Manual Trigger (Production)

```bash
# Manually trigger cleanup (if needed)
curl -X POST https://yourapp.vercel.app/api/cron/cleanup-expired-campaigns \
  -H "Authorization: Bearer your-secret"
```

### View in Vercel Dashboard

1. Go to **Project Settings** ‚Üí **Functions** (or **Cron**)
2. View execution history
3. Check logs and duration
4. Monitor error rates

---

## Monitoring

### Logs

All cron activity is logged with prefix `[MasterCron]` or `[CleanupCron]`.

Check logs in:
- Vercel Dashboard ‚Üí Deployments ‚Üí Function Logs
- Supabase ‚Üí Logs (if using structured logging)
- Your monitoring service (Sentry, DataDog, etc.)

### Key Metrics to Monitor

| Metric | Healthy | Warning | Critical |
|--------|---------|---------|----------|
| Success Rate | > 95% | 80-95% | < 80% |
| Duration | < 2s | 2-5s | > 5s |
| Errors | 0 | 1-2 | 3+ |

---

## Environment Variables

### Required for Cron Security

```bash
# Set in Vercel Dashboard ‚Üí Settings ‚Üí Environment Variables
CRON_SECRET=your-secret-key-here

# Or use Vercel's built-in
VERCEL_CRON_SECRET=<auto-generated>
```

> **Security Note**: Never commit `CRON_SECRET` to git. Set only in Vercel environment.

---

## Upgrading Plans

### Stay on Hobby Plan

Current setup works perfectly on Hobby plan.

**Cost**: Free (same as before)

### Upgrade to Pro Plan

When you upgrade, you can:
- Add more cron jobs (no limit)
- Increase frequency of existing jobs
- Better monitoring/logging included

**No code changes needed** - just enable more crons in `vercel.json`

### Enterprise Solutions

For high-frequency jobs (per-minute), consider:
- **Inngest** - Event-driven job processing
- **QStash** - Serverless message queues
- **AWS Lambda** - Custom infrastructure

These are independent of Vercel plan.

---

## Troubleshooting

### Cron not running

**Check**:
1. `vercel.json` is deployed (check in Vercel dashboard)
2. Function logs show invocation time
3. `CRON_SECRET` is set (if checking authorization)

**Debug**:
```bash
curl -X GET https://yourapp.vercel.app/api/cron/master
# Should return 200 with endpoint info
```

### Cron failed

**Check logs** in Vercel dashboard for:
- Timeout (functions have 10s limit on Hobby)
- Database connection issues
- Missing environment variables

**Solutions**:
- Optimize task logic (reduce complexity)
- Add error handling
- Split into smaller tasks
- Check database pooling

### Too many invocations

**If exceeding 2/day limit**:

Old schedule: `0 * * * *` = 24/day ‚ùå

New schedule: `0 0,12 * * *` = 2/day ‚úÖ

Update `vercel.json` and redeploy.

---

## Best Practices

### ‚úÖ DO

- ‚úÖ Handle partial failures (one task failing shouldn't stop others)
- ‚úÖ Log extensively for debugging
- ‚úÖ Set reasonable timeouts
- ‚úÖ Use database transactions for consistency
- ‚úÖ Test locally before deploying

### ‚ùå DON'T

- ‚ùå Make external API calls inside cron (slow)
- ‚ùå Process large datasets without pagination
- ‚ùå Forget to set `CRON_SECRET` in environment
- ‚ùå Modify `vercel.json` schedule without testing first
- ‚ùå Leave failed tasks unlogged

---

## Files Reference

| File | Purpose |
|------|---------|
| `vercel.json` | Cron schedule configuration |
| `app/api/cron/master/route.ts` | Master orchestrator |
| `app/api/cron/cleanup-expired-campaigns/route.ts` | Cleanup logic (kept for backward compat) |
| `lib/campaigns/cleanup-expired.ts` | Core cleanup implementation |
| `CRON_OPTIMIZATION_STRATEGY.md` | Detailed strategy & alternatives |

---

## Support

For questions or issues:
1. Check Vercel docs: https://vercel.com/docs/cron-jobs
2. Review logs in Vercel dashboard
3. Check `CRON_OPTIMIZATION_STRATEGY.md` for advanced options
4. Test locally before deployment

---

_Last Updated: January 7, 2026_

